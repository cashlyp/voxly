name: Deploy Miniapp to Vercel

on:
  push:
    branches:
      - main
    paths:
      - 'miniapp/**'
      - '.github/workflows/miniapp.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'miniapp/package-lock.json'

      - name: Install dependencies
        working-directory: miniapp
        run: npm ci

      - name: Type check
        working-directory: miniapp
        run: npm run type-check

      - name: Pull Vercel settings
        working-directory: miniapp
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_SCOPE: ${{ secrets.VERCEL_SCOPE }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          set -e
          args=(--yes --environment=production --token="$VERCEL_TOKEN")
          if [ -n "${VERCEL_SCOPE:-}" ]; then
            args+=(--scope "$VERCEL_SCOPE")
          fi
          npx vercel@latest pull "${args[@]}"

      - name: Verify Vercel project config
        working-directory: miniapp
        run: |
          if [ ! -f .vercel/project.json ]; then
            echo "::error::Missing .vercel/project.json. Ensure 'vercel pull' ran successfully or set VERCEL_SCOPE/VERCEL_ORG_ID/VERCEL_PROJECT_ID secrets."
            exit 1
          fi

      - name: Build with Vercel
        working-directory: miniapp
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_SCOPE: ${{ secrets.VERCEL_SCOPE }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VITE_API_URL: ${{ secrets.MINIAPP_API_URL }}
          VITE_BASE: /
        run: |
          set -e
          args=(--prod --token="$VERCEL_TOKEN")
          if [ -n "${VERCEL_SCOPE:-}" ]; then
            args+=(--scope "$VERCEL_SCOPE")
          fi
          npx vercel@latest build \
            "${args[@]}"

      - name: Deploy to Vercel
        working-directory: miniapp
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_SCOPE: ${{ secrets.VERCEL_SCOPE }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          set -e
          args=(--prebuilt --prod --yes --token="$VERCEL_TOKEN")
          if [ -n "${VERCEL_SCOPE:-}" ]; then
            args+=(--scope "$VERCEL_SCOPE")
          fi
          npx vercel@latest deploy \
            "${args[@]}"

      - name: Smoke test API
        env:
          API_URL: ${{ secrets.MINIAPP_API_URL }}
          WEBAPP_SMOKE_INITDATA: ${{ secrets.WEBAPP_SMOKE_INITDATA }}
        run: |
          set -e
          if [ -z "${API_URL:-}" ]; then
            echo "::error::Missing MINIAPP_API_URL secret for smoke test."
            exit 1
          fi
          echo "Pinging ${API_URL}/webapp/ping"
          curl -fsS --max-time 10 "${API_URL}/webapp/ping" \
            | node -e 'const fs=require("fs");const d=JSON.parse(fs.readFileSync(0,"utf8"));if(!d.ok){process.exit(1)}'
          if [ -n "${WEBAPP_SMOKE_INITDATA:-}" ]; then
            payload=$(node -e 'console.log(JSON.stringify({initData: process.env.WEBAPP_SMOKE_INITDATA}))')
            auth=$(curl -fsS --max-time 10 \
              -H "Content-Type: application/json" \
              -d "${payload}" \
              "${API_URL}/webapp/auth")
            token=$(node -e 'const d=JSON.parse(process.env.AUTH||"{}");console.log(d.accessToken||d.token||"")' AUTH="$auth")
            if [ -z "$token" ]; then
              echo "::error::Failed to obtain access token from /webapp/auth."
              exit 1
            fi
            echo "Checking ${API_URL}/webapp/health"
            curl -fsS --max-time 10 \
              -H "Authorization: Bearer ${token}" \
              "${API_URL}/webapp/health" \
              | node -e 'const fs=require("fs");const d=JSON.parse(fs.readFileSync(0,"utf8"));if(!d.ok){process.exit(1)}'
          else
            echo "WEBAPP_SMOKE_INITDATA not set; skipping /webapp/health."
          fi

      - name: Deployment Summary
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ Miniapp successfully deployed to Vercel (Production)"
          else
            echo "❌ Miniapp deployment to Vercel failed"
          fi
