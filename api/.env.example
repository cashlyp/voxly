# --- API Environment --------------------------
# Primary call provider (twilio | aws | vonage)
CALL_PROVIDER=twilio
# Primary SMS provider (twilio | aws | vonage)
SMS_PROVIDER=twilio
# Primary email provider (sendgrid | mailgun | ses)
EMAIL_PROVIDER=sendgrid

# API secret (shared for admin + HMAC signing)
API_SECRET=change-me
# Legacy envs (optional)
# ADMIN_API_TOKEN=
# API_HMAC_SECRET=
API_HMAC_MAX_SKEW_MS=300000

# Twilio credentials (required when CALL_PROVIDER=twilio)
TWILIO_ACCOUNT_SID=
TWILIO_AUTH_TOKEN=
FROM_NUMBER=
TWILIO_GATHER_FALLBACK=true
TWILIO_WEBHOOK_VALIDATION=warn
TWILIO_TTS_MAX_WAIT_MS=1200
TWILIO_FINAL_PROMPT_TTS_TIMEOUT_MS=6000
TWILIO_TTS_STRICT_PLAY=true
TWILIO_TTS_PREWARM_ENABLED=true

# Stream auth for WebSocket connections
STREAM_AUTH_SECRET=
STREAM_AUTH_MAX_SKEW_MS=300000

# AWS Connect stack (required when CALL_PROVIDER=aws)
AWS_REGION=us-east-1
AWS_CONNECT_INSTANCE_ID=
AWS_CONNECT_CONTACT_FLOW_ID=
AWS_CONNECT_QUEUE_ID=
AWS_CONNECT_SOURCE_PHONE_NUMBER=
AWS_TRANSCRIPTS_QUEUE_URL=
AWS_EVENT_BUS_NAME=
AWS_WEBHOOK_VALIDATION=warn
# Optional shared secret for AWS callback/stream forwarders that cannot generate API HMAC headers.
AWS_WEBHOOK_SECRET=

# AWS media + speech
AWS_POLLY_VOICE_ID=Joanna
AWS_POLLY_OUTPUT_BUCKET=
AWS_POLLY_OUTPUT_PREFIX=tts/
AWS_MEDIA_BUCKET=
AWS_PINPOINT_APPLICATION_ID=
AWS_PINPOINT_ORIGINATION_NUMBER=
AWS_PINPOINT_REGION=us-east-1
AWS_TRANSCRIBE_LANGUAGE_CODE=en-US
AWS_TRANSCRIBE_VOCABULARY_FILTER_NAME=

# Vonage Voice/SMS (required when CALL_PROVIDER=vonage)
# Provide either the PEM contents (use \n escapes) or a path to the private key file
VONAGE_API_KEY=
VONAGE_API_SECRET=
VONAGE_APPLICATION_ID=
VONAGE_PRIVATE_KEY=
VONAGE_VOICE_FROM_NUMBER=
VONAGE_SMS_FROM_NUMBER=
VONAGE_ANSWER_URL=
VONAGE_EVENT_URL=
# Official Vonage websocket content type is audio/l16 with 8k/16k sample rate.
VONAGE_WEBSOCKET_CONTENT_TYPE=audio/l16;rate=16000
VONAGE_WEBHOOK_VALIDATION=warn
VONAGE_WEBHOOK_SIGNATURE_SECRET=
VONAGE_WEBHOOK_MAX_SKEW_MS=300000
VONAGE_WEBHOOK_REQUIRE_PAYLOAD_HASH=false
# Enable only after configuring Vonage DTMF event callbacks in the Voice app.
VONAGE_DTMF_WEBHOOK_ENABLED=false

# Server configuration
PORT=3000
SERVER=
CORS_ORIGINS=

# OpenRouter AI configuration
OPENROUTER_API_KEY=
OPENROUTER_MODEL=meta-llama/llama-3.1-8b-instruct:free
OPENROUTER_BACKUP_MODEL=
OPENROUTER_MAX_TOKENS=160
OPENROUTER_RESPONSE_TIMEOUT_MS=25000
OPENROUTER_STREAM_IDLE_TIMEOUT_MS=8000
OPENROUTER_CONTEXT_TOKEN_BUDGET=3500
OPENROUTER_SUMMARY_MAX_CHARS=1200
OPENROUTER_RECENT_TURNS=10
OPENROUTER_MEMORY_FACT_LIMIT=12
OPENROUTER_MEMORY_FACT_MAX_AGE_DAYS=14
OPENROUTER_MEMORY_SUMMARY_MIN_TURNS=10
OPENROUTER_MEMORY_SUMMARY_BATCH=6
OPENROUTER_MAX_TOOL_LOOPS=6
OPENROUTER_TOOL_EXEC_TIMEOUT_MS=12000
OPENROUTER_TOOL_RETRY_LIMIT=1
OPENROUTER_TOOL_BUDGET_PER_INTERACTION=4
OPENROUTER_TOOL_IDEMPOTENCY_TTL_MS=120000
OPENROUTER_STRICT_TOOL_SCHEMAS=true
OPENROUTER_TOOL_CIRCUIT_ENABLED=true
OPENROUTER_TOOL_CIRCUIT_FAILURE_THRESHOLD=4
OPENROUTER_TOOL_CIRCUIT_WINDOW_MS=120000
OPENROUTER_TOOL_CIRCUIT_COOLDOWN_MS=90000
OPENROUTER_PERSONA_CONSISTENCY_THRESHOLD=0.55
OPENROUTER_SLO_RESPONSE_RTT_MS=7000
OPENROUTER_SLO_TTFB_MS=2000
OPENROUTER_SLO_TOOL_FAILURE_RATE=0.3
OPENROUTER_ALERT_WINDOW_MINUTES=15
OPENROUTER_ALERT_TOOL_FAILURE_RATE=0.35
OPENROUTER_ALERT_CIRCUIT_OPEN_COUNT=2
OPENROUTER_ALERT_SLO_DEGRADED_COUNT=1
YOUR_SITE_URL=http://localhost:3000
YOUR_SITE_NAME=Voice Call Bot

# Deepgram configuration
DEEPGRAM_API_KEY=
VOICE_MODEL=aura-asteria-en
DEEPGRAM_MODEL=nova-2

# Telegram webhook fallback
TELEGRAM_BOT_TOKEN=
TELEGRAM_WEBHOOK_VALIDATION=warn
TELEGRAM_ADMIN_CHAT_ID=
TELEGRAM_ADMIN_CHAT_IDS=
TELEGRAM_OPERATOR_CHAT_IDS=
TELEGRAM_VIEWER_CHAT_IDS=

# Email queue + provider request controls
EMAIL_QUEUE_INTERVAL_MS=5000
EMAIL_MAX_RETRIES=5
EMAIL_REQUEST_TIMEOUT_MS=15000
EMAIL_MAX_SUBJECT_CHARS=200
EMAIL_MAX_BODY_CHARS=200000
EMAIL_MAX_BULK_RECIPIENTS=500
EMAIL_DLQ_ALERT_THRESHOLD=25
EMAIL_DLQ_MAX_REPLAYS=2
EMAIL_QUEUE_CLAIM_LEASE_MS=60000
EMAIL_QUEUE_STALE_SENDING_MS=180000
EMAIL_PROVIDER_EVENTS_TTL_DAYS=14
EMAIL_CIRCUIT_BREAKER_ENABLED=true
EMAIL_CIRCUIT_BREAKER_FAILURE_THRESHOLD=5
EMAIL_CIRCUIT_BREAKER_WINDOW_MS=120000
EMAIL_CIRCUIT_BREAKER_COOLDOWN_MS=120000
# Email webhook auth: off | warn | strict
EMAIL_WEBHOOK_VALIDATION=warn
# Optional shared secret for /webhook/email when HMAC headers are not available.
EMAIL_WEBHOOK_SECRET=
# Optional secret to sign/verify one-click unsubscribe links.
EMAIL_UNSUBSCRIBE_SECRET=

# SMS provider/runtime controls
SMS_PROVIDER_TIMEOUT_MS=15000
SMS_AI_TIMEOUT_MS=12000
SMS_MAX_MESSAGE_CHARS=1600
SMS_MAX_BULK_RECIPIENTS=100
SMS_PROVIDER_FAILOVER_ENABLED=true
SMS_CIRCUIT_BREAKER_ENABLED=true
SMS_CIRCUIT_BREAKER_FAILURE_THRESHOLD=3
SMS_CIRCUIT_BREAKER_WINDOW_MS=120000
SMS_CIRCUIT_BREAKER_COOLDOWN_MS=120000
SMS_WEBHOOK_DEDUPE_TTL_MS=300000
SMS_RECONCILE_ENABLED=true
SMS_RECONCILE_INTERVAL_MS=120000
SMS_RECONCILE_STALE_MINUTES=15
SMS_RECONCILE_BATCH_SIZE=50

# Outbound send abuse controls (windowed limits)
OUTBOUND_RATE_LIMIT_WINDOW_MS=60000
SMS_OUTBOUND_USER_RATE_LIMIT_PER_WINDOW=15
SMS_OUTBOUND_GLOBAL_RATE_LIMIT_PER_WINDOW=120
EMAIL_OUTBOUND_USER_RATE_LIMIT_PER_WINDOW=20
EMAIL_OUTBOUND_GLOBAL_RATE_LIMIT_PER_WINDOW=120
OUTBOUND_HANDLER_TIMEOUT_MS=30000

# Database schema guardrails
DB_SCHEMA_VERSION=2
DB_SCHEMA_STRICT=true
# Validate DB integrity at startup (recommended)
DB_STARTUP_INTEGRITY_CHECK=true
# If true, corrupted DB files are quarantined and a fresh DB is created automatically
DB_AUTO_REBUILD_ON_CORRUPT=true
# Optional path for quarantined corrupted DB files
DB_CORRUPT_BACKUP_DIR=

# Call recording
RECORDING_ENABLED=false

# Optional defaults
DEFAULT_SMS_BUSINESS_ID=
CONFIG_COMPLIANCE_MODE=safe
DTMF_ENCRYPTION_KEY=

# Inbound call defaults (optional)
INBOUND_PROMPT=
INBOUND_FIRST_MESSAGE=
# Optional pre-connect audio before stream starts
INBOUND_PRECONNECT_MESSAGE=
INBOUND_PRECONNECT_PAUSE_S=1
# Timeout to detect missing media after stream start (ms)
INBOUND_STREAM_FIRST_MEDIA_TIMEOUT_MS=8000
# Inbound rate limiting (0 disables)
INBOUND_RATE_LIMIT_MAX=0
INBOUND_RATE_LIMIT_WINDOW_S=60
INBOUND_RATE_LIMIT_SMS=false
INBOUND_RATE_LIMIT_CALLBACK=false
INBOUND_CALLBACK_DELAY_MIN=15
# JSON object mapping numbers to overrides, e.g. {"+15551234567":{"prompt":"...","first_message":"..."}}
INBOUND_NUMBER_ROUTES=

# Webhook retry backoff (ms + attempts)
WEBHOOK_RETRY_BASE_MS=5000
WEBHOOK_RETRY_MAX_MS=60000
WEBHOOK_RETRY_MAX_ATTEMPTS=5
WEBHOOK_TELEGRAM_TIMEOUT_MS=15000

# Provider failover (outbound)
PROVIDER_FAILOVER_ENABLED=true
PROVIDER_ERROR_THRESHOLD=3
PROVIDER_ERROR_WINDOW_S=120
PROVIDER_COOLDOWN_S=300

# Keypad guard for Vonage digit-capture parity
KEYPAD_GUARD_ENABLED=true
KEYPAD_VONAGE_DTMF_TIMEOUT_MS=12000
KEYPAD_PROVIDER_OVERRIDE_COOLDOWN_S=1800

# Call job processor (durable queue)
CALL_JOB_PROCESSOR_INTERVAL_MS=5000
CALL_JOB_RETRY_BASE_MS=5000
CALL_JOB_RETRY_MAX_MS=60000
CALL_JOB_MAX_ATTEMPTS=3
CALL_JOB_TIMEOUT_MS=45000
CALL_JOB_DLQ_ALERT_THRESHOLD=20
CALL_JOB_DLQ_MAX_REPLAYS=2

# Call SLO thresholds
CALL_SLO_FIRST_MEDIA_MS=4000
CALL_SLO_ANSWER_DELAY_MS=12000
CALL_SLO_STT_FAILURES=3

# Payment feature controls
PAYMENT_FEATURE_ENABLED=true
PAYMENT_KILL_SWITCH=false
PAYMENT_ALLOW_TWILIO=true
PAYMENT_REQUIRE_SCRIPT_OPT_IN=false
PAYMENT_DEFAULT_CURRENCY=USD
# 0 disables min/max enforcement
PAYMENT_MIN_AMOUNT=0
PAYMENT_MAX_AMOUNT=0
PAYMENT_WEBHOOK_IDEMPOTENCY_TTL_MS=300000
PAYMENT_MAX_ATTEMPTS_PER_CALL=3
PAYMENT_RETRY_COOLDOWN_MS=20000
PAYMENT_RECONCILE_ENABLED=true
PAYMENT_RECONCILE_INTERVAL_MS=120000
PAYMENT_RECONCILE_STALE_SECONDS=240
PAYMENT_RECONCILE_BATCH_SIZE=20
PAYMENT_SMS_FALLBACK_ENABLED=false
PAYMENT_SMS_FALLBACK_URL_TEMPLATE=
PAYMENT_SMS_FALLBACK_MESSAGE_TEMPLATE=Complete your payment securely here: {payment_url}
PAYMENT_SMS_FALLBACK_TTL_SECONDS=900
PAYMENT_SMS_FALLBACK_SECRET=
PAYMENT_SMS_FALLBACK_MAX_PER_CALL=1
